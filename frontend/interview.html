<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Session | MockPrep AI</title>
    
    <script>
        (function() {
            if (sessionStorage.getItem('isLoggedIn') !== 'true') {
                window.location.href = 'login.html';
            }
        })();
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #0f172a; --bg-card: #1e293b; --primary: #6366f1;
            --accent: #10b981; --danger: #ef4444; --text-main: #f8fafc;
            --text-dim: #94a3b8; --border: rgba(255, 255, 255, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        header {
            height: 70px; background: var(--bg-card); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 2rem;
        }
        .status-badge { color: var(--accent); font-size: 0.8rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 10px; height: 10px; background: var(--accent); border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        .progress-container { width: 40%; height: 8px; background: #0f172a; border-radius: 10px; }
        #progressBar { width: 0%; height: 100%; background: var(--primary); border-radius: 10px; transition: 0.5s ease; }

        main { display: grid; grid-template-columns: 450px 1fr; flex: 1; overflow: hidden; }

        .question-panel { background: var(--bg-card); border-right: 1px solid var(--border); padding: 2.5rem; overflow-y: auto; }
        .q-meta { display: flex; gap: 8px; margin-bottom: 1rem; }
        .badge { padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; border: 1px solid var(--border); }
        .badge-primary { background: var(--primary); border: none; }

        .question-text h2 { font-size: 1.6rem; margin-bottom: 1.5rem; line-height: 1.4; }
        .question-description { color: var(--text-dim); line-height: 1.7; font-size: 1rem; }

        .workspace-panel { padding: 1.5rem; display: flex; flex-direction: column; background: #0b1120; position: relative; }
        
        .editor-container {
            flex: 1; background: rgba(30, 41, 59, 0.4); border-radius: 16px; border: 1px solid var(--border);
            display: flex; flex-direction: column; overflow: hidden; backdrop-filter: blur(10px);
        }
        .editor-header { background: #1e293b; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); font-size: 0.85rem; }

        textarea { flex: 1; background: transparent; border: none; color: #e2e8f0; padding: 25px; font-size: 1.1rem; resize: none; outline: none; line-height: 1.6; }

        .mic-controls { display: none; gap: 10px; align-items: center; }
        .btn-mic { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.75rem; font-weight: 600; transition: 0.2s; display: flex; align-items: center; gap: 5px; }
        .btn-mic.start { background: var(--accent); color: white; }
        .btn-mic.stop { background: var(--danger); color: white; }
        .mic-status { width: 8px; height: 8px; border-radius: 50%; background: #334155; }
        .mic-status.active { background: var(--danger); animation: pulse 1s infinite; }

        .avatar-box {
            position: absolute; bottom: 100px; right: 40px; width: 180px; height: 130px;
            background: #000; border-radius: 16px; border: 2px solid var(--primary);
            display: flex; align-items: center; justify-content: center; box-shadow: 0 20px 40px rgba(0,0,0,0.6);
        }
        .avatar-label { position: absolute; top: 10px; left: 10px; font-size: 0.6rem; background: var(--primary); padding: 2px 6px; border-radius: 4px; font-weight: 800; }

        .action-bar { height: 85px; background: var(--bg-card); border-top: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 3rem; }
        .btn { padding: 12px 28px; border-radius: 10px; font-weight: 700; cursor: pointer; transition: 0.3s; border: none; font-size: 0.95rem; }
        .btn-secondary { background: transparent; color: var(--text-dim); border: 1px solid var(--border); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 8px 15px rgba(99, 102, 241, 0.3); }
        .btn:hover { transform: translateY(-2px); }
    </style>
</head>
<body>

    <header>
        <div class="status-badge"><div class="status-dot"></div> LIVE INTERVIEW</div>
        <div class="progress-container"><div id="progressBar"></div></div>
        <div id="timer" style="font-family: 'Fira Code'; font-weight: 700;">10:00</div>
    </header>

    <main>
        <section class="question-panel">
            <div class="q-meta">
                <span id="qNum" class="badge">Question 1</span>
                <span id="qType" class="badge badge-primary">Theory</span>
                <span id="qDiff" class="badge">Medium</span>
            </div>
            <div class="question-text">
                <h2 id="qTitle">Initializing Session...</h2>
                <div id="qDesc" class="question-description">Please wait while the AI loads the questions.</div>
            </div>
        </section>

        <section class="workspace-panel">
            <div class="editor-container">
                <div class="editor-header">
                    <span id="workspaceLabel">Response Editor</span>
                    <div class="mic-controls" id="micControls">
                        <div id="micIndicator" class="mic-status"></div>
                        <button class="btn-mic start" onclick="startMic()">Start Mic</button>
                        <button class="btn-mic stop" onclick="stopMic()">Stop Mic</button>
                    </div>
                    <span id="maxScoreDisplay" style="color: var(--text-dim)">Max Score: 10</span>
                </div>
                <textarea id="answerArea" placeholder="Begin typing your answer here..."></textarea>
            </div>

            <div class="avatar-box" id="avatarDisplay">
                <div class="avatar-label">AI INTERVIEWER</div>
                <span id="avatarEmoji" style="font-size: 4rem;">üë©‚Äçüíº</span>
            </div>
        </section>
    </main>

    <footer class="action-bar">
        <button class="btn btn-secondary" onclick="confirmExit()">Quit Session</button>
        <div style="display: flex; gap: 1.5rem;">
            <button id="skipBtn" class="btn btn-secondary" onclick="handleSkip()">Skip Question</button>
            <button id="nextBtn" class="btn btn-primary" onclick="handleSubmit()">Submit & Next</button>
        </div>
    </footer>

    <script>
        const FOLDER_PATH = 'questions/'; 
        const SUBJECT_MAP = {
            'python': FOLDER_PATH + 'python.json',
            'dbms': FOLDER_PATH + 'dbms.json',
            'java': FOLDER_PATH + 'java.json',
            'ds': FOLDER_PATH + 'ds.json'
        };

        let state = {
            questions: [],
            currentIndex: 0,
            responses: [],
            timer: 600,
            subject: localStorage.getItem('session_subject'),
            persona: localStorage.getItem('session_persona') || 'Lady',
            isRecording: false
        };

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.onresult = (event) => {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }
                document.getElementById('answerArea').value = transcript;
            };
        }

        const synth = window.speechSynthesis;

        document.addEventListener('DOMContentLoaded', () => {
            if (!state.subject) { window.location.href = 'selections.html'; return; }
            initSession();
            startTimer();
            updatePersonaUI();
        });

        // --- üß† Balanced Question Picker Logic ---
        
        async function initSession() {
            const file = SUBJECT_MAP[state.subject.toLowerCase()];
            try {
                const res = await fetch(file);
                if (!res.ok) throw new Error("File not found");
                const allData = await res.json();
                
                // Filter by type (case-insensitive for safety)
                const theoryQs = allData.filter(q => q.type.toLowerCase() === 'theory');
                const codingQs = allData.filter(q => q.type.toLowerCase() === 'coding');

                // Shuffle both pools
                const shuffledTheory = theoryQs.sort(() => 0.5 - Math.random());
                const shuffledCoding = codingQs.sort(() => 0.5 - Math.random());

                // Take up to 5 of each to make a balanced set of 10
                state.questions = [
                    ...shuffledTheory.slice(0, 5),
                    ...shuffledCoding.slice(0, 5)
                ].sort(() => 0.5 - Math.random()); // Final shuffle of the combined set

                if (state.questions.length === 0) throw new Error("No questions found");

                renderQuestion();
            } catch (err) {
                document.getElementById('qTitle').innerText = "Load Error";
                document.getElementById('qDesc').innerText = `Ensure folder '${FOLDER_PATH}' contains '${state.subject.toLowerCase()}.json' with both 'theory' and 'coding' types.`;
            }
        }

        function updatePersonaUI() {
            document.getElementById('avatarEmoji').innerText = state.persona === 'Lady' ? 'üë©‚Äçüíº' : 'üë®‚Äçüíº';
        }

        function renderQuestion() {
            const q = state.questions[state.currentIndex];
            const area = document.getElementById('answerArea');
            
            stopMic(); 
            document.getElementById('qNum').innerText = `Question ${state.currentIndex + 1}`;
            document.getElementById('qTitle').innerText = q.question;
            document.getElementById('qType').innerText = q.type;
            document.getElementById('qDiff').innerText = q.difficulty;
            document.getElementById('maxScoreDisplay').innerText = `Max Score: ${q.max_score}`;
            document.getElementById('progressBar').style.width = `${((state.currentIndex + 1) / state.questions.length) * 100}%`;
            
            area.value = "";

            // --- üöÄ Dynamic UI Switching ---
            if (q.type.toLowerCase() === 'coding') {
                document.getElementById('micControls').style.display = 'none';
                document.getElementById('avatarDisplay').style.display = 'none';
                document.getElementById('workspaceLabel').innerText = "Code Editor";
                area.style.fontFamily = "'Fira Code', monospace";
                area.placeholder = "// Write your code solution here...";
            } else {
                document.getElementById('micControls').style.display = 'flex';
                document.getElementById('avatarDisplay').style.display = 'flex';
                document.getElementById('workspaceLabel').innerText = "Response Editor";
                area.style.fontFamily = "'Inter', sans-serif";
                area.placeholder = "Click 'Start Mic' to answer verbally or type here...";
                speakQuestion(q.question);
            }
        }

        function speakQuestion(text) {
            synth.cancel(); 
            const msg = new SpeechSynthesisUtterance(text);
            msg.pitch = state.persona === 'Sir' ? 0.85 : 1.1;
            msg.onstart = () => stopMic(); 
            synth.speak(msg);
        }

        function startMic() {
            if (recognition && !state.isRecording) {
                recognition.start();
                state.isRecording = true;
                document.getElementById('micIndicator').classList.add('active');
            }
        }

        function stopMic() {
            if (recognition && state.isRecording) {
                recognition.stop();
                state.isRecording = false;
                document.getElementById('micIndicator').classList.remove('active');
            }
        }

        function handleSubmit() {
            const q = state.questions[state.currentIndex];
            const ans = document.getElementById('answerArea').value;
            stopMic();

            let matches = 0;
            q.keywords.forEach(word => { if (ans.toLowerCase().includes(word.toLowerCase())) matches++; });
            const score = Math.round((matches / q.keywords.length) * q.max_score);

            state.responses.push({
                question: q.question,
                userAnswer: ans,
                earned_score: score,
                max_score: q.max_score,
                expected: q.answer,
                type: q.type
            });

            moveNext();
        }

        function handleSkip() {
            stopMic();
            state.responses.push({ userAnswer: "SKIPPED", earned_score: 0 });
            moveNext();
        }

        function moveNext() {
            if (state.currentIndex < state.questions.length - 1) {
                state.currentIndex++;
                renderQuestion();
            } else {
                sessionStorage.setItem('interview_results', JSON.stringify(state.responses));
                window.location.href = 'result.html';
            }
        }

        function startTimer() {
            const el = document.getElementById('timer');
            const itv = setInterval(() => {
                state.timer--;
                let m = Math.floor(state.timer / 60);
                let s = state.timer % 60;
                el.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
                if (state.timer <= 0) { clearInterval(itv); window.location.href = 'result.html'; }
            }, 1000);
        }

        function confirmExit() { if(confirm("Are you sure? Progress will be lost.")) window.location.href = 'main.html'; }
    </script>
</body>
</html>